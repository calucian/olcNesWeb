!function(t){var i={};function s(h){if(i[h])return i[h].exports;var e=i[h]={i:h,l:!1,exports:{}};return t[h].call(e.exports,e,e.exports,s),e.l=!0,e.exports}s.m=t,s.c=i,s.d=function(t,i,h){s.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:h})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,i){if(1&i&&(t=s(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var h=Object.create(null);if(s.r(h),Object.defineProperty(h,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var e in t)s.d(h,e,function(i){return t[i]}.bind(null,e));return h},s.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(i,"a",i),i},s.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},s.p="",s(s.s=0)}([function(t,i,s){"use strict";function h(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}s.r(i);var e=function(){function t(i,s,h){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.cpu=i,this.ppu=s,this.apu=h,this.cart=null,this.cpuRam=Array(2048).fill(0),this.controller=[],this.nSystemClockCounter=0,this.controller_state=[],this.dma_page=0,this._dma_addr=0,this.dma_data=0,this.dma_dummy=!0,this.dma_transfer=!1,this.audioTimePerNESClock=0,this.audioTimePerSystemSample=0,this.audioTime=0}var i,s,e;return i=t,(s=[{key:"cpuWrite",value:function(t,i){!1!==this.cart.cpuWrite(t,i)||(t>=0&&t<=8191?this.cpuRam[2047&t]=i:t>=8192&&t<=16383?this.ppu.cpuWrite(7&t,i):t>=16384&&t<=16403||16405===t||16407===t?this.apu.cpuWrite(t,i):16404===t?(this.dma_page=i,this.dma_addr=0,this.dma_transfer=!0):t>=16406&&t<=16407&&(this.controller_state[1&t]=this.controller[1&t]))}},{key:"insertCartridge",value:function(t){this.cart=t,this.ppu.ConnectCartridge(t)}},{key:"cpuRead",value:function(t,i){var s=0,h=this.cart.cpuRead(t,s);return!1!==h?s=h:t>=0&&t<=8191?s=this.cpuRam[2047&t]:t>=8192&&t<=16383?s=this.ppu.cpuRead(7&t,i):t>=16406&&t<=16407&&(s=(128&this.controller_state[1&t])>0,this.controller_state[1&t]<<=1),s}},{key:"setSampleFrequency",value:function(t){this.audioTimePerSystemSample=1e3/t,this.audioTimePerNESClock=.000186243393}},{key:"reset",value:function(){this.cart.reset(),this.cpu.reset(),this.ppu.reset(),this.nSystemClockCounter=0,this.dma_page=0,this.dma_addr=0,this.dma_data=0,this.dma_dummy=!0,this.dma_transfer=!1}},{key:"clock",value:function(){this.ppu.clock(),this.nSystemClockCounter%3==0&&(this.dma_transfer?this.dma_dummy?this.nSystemClockCounter%2==1&&(this.dma_dummy=!1):this.nSystemClockCounter%2==0?this.dma_data=this.cpuRead(this.dma_page<<8|this.dma_addr):(this.ppu.OAMWrite(this.dma_addr,this.dma_data),this.dma_addr++,0===this.dma_addr&&(this.dma_transfer=!1,this.dma_dummy=!0)):this.cpu.clock()),this.ppu.nmi&&(this.ppu.nmi=!1,this.cpu.nmi()),this.nSystemClockCounter++}},{key:"dma_addr",set:function(t){this._dma_addr=255&t},get:function(){return this._dma_addr}}])&&h(i.prototype,s),e&&h(i,e),t}();function r(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var a=function(){function t(i,s){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.nPRGBanks=i,this.nCHRBanks=s,this.reset()}var i,s,h;return i=t,(s=[{key:"cpuMapRead",value:function(t){return!1}},{key:"cpuMapWrite",value:function(t,i){return!1}},{key:"ppuMapRead",value:function(t){return t>=0&&t<=8191&&t}},{key:"ppuMapWrite",value:function(t){return t>=0&&t<=8191&&0===this.nCHRBanks&&t}},{key:"reset",value:function(){}}])&&r(i.prototype,s),h&&r(i,h),t}();function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}function p(t,i){return!i||"object"!==n(i)&&"function"!=typeof i?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):i}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function c(t,i){return(c=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}var u=function(t){function i(t,s){var h;return function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,i),(h=p(this,l(i).call(this,t,s))).reset(),h}var s,h,e;return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&c(t,i)}(i,t),s=i,(h=[{key:"cpuMapRead",value:function(t){return t>=32768&&t<=65535&&t&(this.nPRGBanks>1?32767:16383)}},{key:"cpuMapWrite",value:function(t,i){return t>=32768&&t<=65535&&t&(this.nPRGBanks>1?32767:16383)}},{key:"ppuMapRead",value:function(t){return t>=0&&t<=8191&&t}},{key:"ppuMapWrite",value:function(t){return t>=0&&t<=8191&&0===this.nCHRBanks&&t}},{key:"reset",value:function(){}}])&&o(s.prototype,h),e&&o(s,e),i}(a);function d(t){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function m(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}function f(t,i){return!i||"object"!==d(i)&&"function"!=typeof i?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):i}function b(t){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function y(t,i){return(y=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}var k=function(t){function i(t,s,h){var e;return function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,i),(e=f(this,b(i).call(this,t,s))).nCHRBankSelect4Lo=0,e.nCHRBankSelect4Hi=0,e.nCHRBankSelect8=0,e.nPRGBankSelect16Lo=0,e.nPRGBankSelect16Hi=0,e.nPRGBankSelect32=0,e.nLoadRegister=0,e.nLoadRegisterCount=0,e.nControlRegister=0,e.mirrormode=h,e.vRAMStatic=[],e.reset(),e}var s,h,e;return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&y(t,i)}(i,t),s=i,(h=[{key:"cpuMapRead",value:function(t,i){if(t>=24576&&t<=32767)return i.data=this.vRAMStatic[8191&t],4294967295;if(t>=32768){if(!(8&this.nControlRegister))return 32768*this.nPRGBankSelect32+(32767&t);if(t>=32768&&t<=49151)return 16384*this.nPRGBankSelect16Lo+(16383&t);if(t>=49152&&t<=65535)return 16384*this.nPRGBankSelect16Hi+(16383&t)}return!1}},{key:"cpuMapWrite",value:function(t,i){if(t>=24576&&t<=32767)return this.vRAMStatic[8191&t]=i,4294967295;if(t>=32768)if(128&i)this.nLoadRegister=0,this.nLoadRegisterCount=0,this.nControlRegister=12|this.nControlRegister;else if(this.nLoadRegister>>=1,this.nLoadRegister|=(1&i)<<4,this.nLoadRegisterCount++,5===this.nLoadRegisterCount){var s=t>>13&3;if(0===s)switch(this.nControlRegister=31&this.nLoadRegister,3&this.nControlRegister){case 0:this.mirrormode=H.ONESCREEN_LO;break;case 1:this.mirrormode=H.ONESCREEN_HI;break;case 2:this.mirrormode=H.VERTICAL;break;case 3:this.mirrormode=H.HORIZONTAL}else if(1===s)16&this.nControlRegister?this.nCHRBankSelect4Lo=31&this.nLoadRegister:this.nCHRBankSelect8=30&this.nLoadRegister;else if(2===s)16&this.nControlRegister&&(this.nCHRBankSelect4Hi=31&this.nLoadRegister);else if(3===s){var h=this.nControlRegister>>2&3;0===h||1===h?this.nPRGBankSelect32=(14&this.nLoadRegister)>>1:2===h?(this.nPRGBankSelect16Lo=0,this.nPRGBankSelect16Hi=15&this.nLoadRegister):3===h&&(this.nPRGBankSelect16Lo=15&this.nLoadRegister,this.nPRGBankSelect16Hi=this.nPRGBanks-1)}this.nLoadRegister=0,this.nLoadRegisterCount=0}return!1}},{key:"ppuMapRead",value:function(t){if(t<8192){if(0===this.nCHRBanks)return t;if(!(16&this.nControlRegister))return 8192*this.nCHRBankSelect8+(8191&t);if(t>=0&&t<=4095)return 4096*this.nCHRBankSelect4Lo+(4095&t);if(t>=4096&&t<=8191)return 4096*this.nCHRBankSelect4Hi+(4095&t)}return!1}},{key:"ppuMapWrite",value:function(t){return t<8192&&(0!==this.nCHRBanks||t)}},{key:"reset",value:function(){this.nControlRegister=28,this.nLoadRegister=0,this.nLoadRegisterCount=0,this.nCHRBankSelect4Lo=0,this.nCHRBankSelect4Hi=0,this.nCHRBankSelect8=0,this.nPRGBankSelect32=0,this.nPRGBankSelect16Lo=0,this.nPRGBankSelect16Hi=this.nPRGBanks-1}}])&&m(s.prototype,h),e&&m(s,e),i}(a);function _(t){return(_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function x(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}function v(t,i){return!i||"object"!==_(i)&&"function"!=typeof i?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):i}function w(t){return(w=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function g(t,i){return(g=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}var S=function(t){function i(t,s){var h;return function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,i),(h=v(this,w(i).call(this,t,s))).nPRGBankSelectLo=1,h.nPRGBankSelectHi=t-1,h.reset(),h}var s,h,e;return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&g(t,i)}(i,t),s=i,(h=[{key:"cpuMapRead",value:function(t){return t>=32768&&t<=49151?16384*this.nPRGBankSelectLo+(16383&t):t>=49152&&t<=65535&&16384*this.nPRGBankSelectHi+(16383&t)}},{key:"cpuMapWrite",value:function(t,i){return t>=32768&&t<=65535&&(this.nPRGBankSelectLo=15&i,!0)}},{key:"ppuMapRead",value:function(t){return t<8192&&0===this.nCHRBanks&&t}},{key:"ppuMapWrite",value:function(t){return t<8192&&0===this.nCHRBanks&&t}},{key:"reset",value:function(){this.nPRGBankSelectLo=1,this.nPRGBankSelectHi=this.nPRGBanks-1}}])&&x(s.prototype,h),e&&x(s,e),i}(a);function z(t){return(z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function R(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}function C(t,i){return!i||"object"!==z(i)&&"function"!=typeof i?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):i}function A(t){return(A=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function P(t,i){return(P=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}var O=function(t){function i(t,s){var h;return function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,i),(h=C(this,A(i).call(this,t,s))).nCHRBankSelect=0,h.reset(),h}var s,h,e;return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&P(t,i)}(i,t),s=i,(h=[{key:"cpuMapRead",value:function(t){if(t>=32768&&t<=65535){if(1===this.nPRGBanks)return 16383&t;if(2===this.nPRGBanks)return 32767&t}return!1}},{key:"cpuMapWrite",value:function(t,i){return t>=32768&&t<=65535&&(this.nCHRBankSelect=3&i,!0)}},{key:"ppuMapRead",value:function(t){return t<8192&&8192*this.nCHRBankSelect+t}},{key:"ppuMapWrite",value:function(t){return!1}},{key:"reset",value:function(){this.nCHRBankSelect=0}}])&&R(s.prototype,h),e&&R(s,e),i}(a);function M(t){return(M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function B(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}function F(t,i){return!i||"object"!==M(i)&&"function"!=typeof i?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):i}function G(t){return(G=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function j(t,i){return(j=Object.setPrototypeOf||function(t,i){return t.__proto__=i,t})(t,i)}var L=function(t){function i(t,s){var h;return function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,i),(h=F(this,G(i).call(this,t,s))).nCHRBankSelect=0,h.nPRGBankSelect=0,h.reset(),h}var s,h,e;return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),i&&j(t,i)}(i,t),s=i,(h=[{key:"cpuMapRead",value:function(t){return t>=32768&&t<=65535&&32768*this.nPRGBankSelect+(32767&t)}},{key:"cpuMapWrite",value:function(t,i){return t>=32768&&t<=65535&&(this.nCHRBankSelect=3&i,this.nPRGBankSelect=(48&i)>>4,!0)}},{key:"ppuMapRead",value:function(t){return t<8192&&8192*this.nCHRBankSelect+t}},{key:"ppuMapWrite",value:function(t){return!1}},{key:"reset",value:function(){this.nPRGBankSelectLo=1,this.nPRGBankSelectHi=this.nPRGBanks-1}}])&&B(s.prototype,h),e&&B(s,e),i}(a);var I=function(t){switch(t.readUInt32BE(0)){case 1431193926:return{is_unif:!0};case 1313166106:break;default:throw new Error("Not a .nes file (bad magic)")}var i={},s=t.readUInt8(4);i.prg_rom_size=16384*s;var h=t.readUInt8(5);i.chr_rom_size=8192*h,i.has_chr_ram=0===h;var e=t.readUInt8(6);i.mirroring=1&e?"vertical":"horizontal",i.has_battery_backed_sram=!!(2&e),i.has_trainer=!!(4&e),i.four_screen_mode=!!(8&e),i.mapper=e>>4;var r=t.readUInt8(7);if(i.is_vs_unisystem=!!(1&r),i.is_playchoice10=!!(2&r),i.is_nes2_0=(4&r)>>2==2,i.mapper|=240&r,i.is_nes2_0=8==(12&r),i.is_ines=0==(12&r),i.is_nes2_0||i.is_ines||(i.is_archaic=!0),!i.is_nes2_0){var a=t.readUInt8(8);i.prg_ram_size=8192*a;var n=t.readUInt8(9);i.tv_system9_pal=1&n?"PAL":"NTSC",i.reserved9=n>>1;var o=t.readUInt8(10);i.tv_system10=3&o,i.has_prg_ram=!!(16&o),i.has_bus_conflicts=!!(32&o)}if(i.is_nes2_0){var p=function(t){if(0===t)return 0;if(15==t)throw new Error("reserved value ".concat(t," in size"));return 1<<6+t},l=t.readUInt8(8);i.submapper=15&l,i.mapper|=l>>4<<8;var c=t.readUInt8(9);i.prg_rom_size|=(15&c)<<8,i.chr_rom_size|=(15&c)<<8;var u=t.readUInt8(10);i.prg_ram_not_battery_backed=p(15&u),i.prg_ram_is_battery_backed=p((240&u)>>4);var d=t.readUInt8(11);i.chr_ram_not_battery_backed=p(15&d),i.chr_ram_is_battery_backed=p((240&d)>>4);var m=t.readUInt8(12);i.tv_system=1&m?"PAL":"NTSC",2&m&&(i.tv_system="both");var f=t.readUInt8(13);i.vs_ppu=["RP2C03B","RP2C03G","RP2C04-0001","RP2C04-0002","RP2C04-0003","RP2C04-0004","RC2C03B","RC2C03C","RC2C05-01","RC2C05-02","RC2C05-03","RC2C05-04","RC2C05-05","not defined (13)","not defined (14)","not defined (15)"][15&f],i.vs_mode=(240&f)>>4;var b=t.readUInt8(14);i.extra_roms=3&b;var y=t.readUInt8(15);i.reserved15=y}i.header=t.slice(0,16),i.has_trainer&&(i.trainer=t.slice(16,528));var k=16+(i.has_trainer?512:0);if(i.prg_rom=t.slice(k,k+i.prg_rom_size),i.prg_rom.length!==i.prg_rom_size)throw new Error("PRG ROM bad read: ".concat(i.prg_rom.length," != ").concat(i.prg_rom_size));var _=k+i.prg_rom_size;if(i.chr_rom=t.slice(_,_+i.chr_rom_size),i.chr_rom.length!==i.chr_rom_size)throw new Error("CHR ROM bad read: ".concat(i.chr_rom.length," != ").concat(i.chr_rom_size));return i.trailer=t.slice(_+i.chr_rom_size),i};function D(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var E=function(){function t(){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.mirror=self.HORIZONTAL,this.nMapperID=0,this.nPRGBanks=0,this.nCHRBanks=0,this.vPRGMemory=[],this.vCHRMemory=[],this.pMapper=null,this.bImageValid=!1}var i,s,h;return i=t,(s=[{key:"loadFile",value:function(t,i){var s=this,h=new FileReader;h.onload=function(t){var h=I(new buffer.Buffer(t.target.result));switch(s.vPRGMemory=h.prg_rom,h.chr_rom_size&&(s.vCHRMemory=h.chr_rom),s.mirror={horizontal:1,vertical:2,vcertical:3,vecertical:4}[h.mirroring],s.info=h,s.nPRGBanks=h.prg_rom_size/16384,s.nCHRBanks=h.chr_rom_size/8192,h.mapper){case 0:s.pMapper=new u(s.nPRGBanks,s.nCHRBanks);break;case 1:s.pMapper=new k(s.nPRGBanks,s.nCHRBanks,s.mirror);break;case 2:s.pMapper=new S(s.nPRGBanks,s.nCHRBanks);break;case 3:s.pMapper=new O(s.nPRGBanks,s.nCHRBanks);break;case 66:s.pMapper=new L(s.nPRGBanks,s.nCHRBanks)}i(),s.bImageValid=!0},h.readAsArrayBuffer(t)}},{key:"ImageValid",value:function(){return this.bImageValid}},{key:"cpuRead",value:function(t){var i={data:null},s=this.pMapper.cpuMapRead(t,i);return!1!==s&&(4294967295===s?i.data:this.vPRGMemory[s])}},{key:"cpuWrite",value:function(t,i){var s=this.pMapper.cpuMapWrite(t,i);return!1!==s&&(this.vPRGMemory[s]=i,!0)}},{key:"ppuRead",value:function(t){var i=this.pMapper.ppuMapRead(t);return!1!==i&&this.vCHRMemory[i]}},{key:"ppuWrite",value:function(t,i){var s=this.pMapper.ppuMapWrite(t,i);return!1!==s&&(this.vCHRMemory[s]=i,!0)}},{key:"reset",value:function(){this.pMapper&&this.pMapper.reset()}}])&&D(i.prototype,s),h&&D(i,h),t}();E.HORIZONTAL=1,E.VERTICAL=2,E.ONESCREEN_LO=3,E.ONESCREEN_HI=4;var H=E;function N(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var T=function(){function t(){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.pc=0,this.A=0,this.X=0,this.Y=0,this.S=0,this.N=0,this.Z=1,this.C=0,this.V=0,this.I=0,this.D=0,this.tmp=0,this.addr=0,this.opcode=0,this.cycles=0,this.clock_count=0,this.lookup=[],this.lookup[0]=[this.imp,this.brk],this.lookup[1]=[this.izx,this.ora],this.lookup[2]=[this.imp,this.kil],this.lookup[3]=[this.izx,this.slo,this.rmw],this.lookup[4]=[this.zp,this.nop],this.lookup[5]=[this.zp,this.ora],this.lookup[6]=[this.zp,this.asl,this.rmw],this.lookup[7]=[this.zp,this.slo,this.rmw],this.lookup[8]=[this.imp,this.php],this.lookup[9]=[this.imm,this.ora],this.lookup[10]=[this.imp,this.asla],this.lookup[11]=[this.imm,this.anc],this.lookup[12]=[this.abs,this.nop],this.lookup[13]=[this.abs,this.ora],this.lookup[14]=[this.abs,this.asl,this.rmw],this.lookup[15]=[this.abs,this.slo,this.rmw],this.lookup[16]=[this.rel,this.bpl],this.lookup[17]=[this.izy,this.ora],this.lookup[18]=[this.imp,this.kil],this.lookup[19]=[this.izy,this.slo,this.rmw],this.lookup[20]=[this.zpx,this.nop],this.lookup[21]=[this.zpx,this.ora],this.lookup[22]=[this.zpx,this.asl,this.rmw],this.lookup[23]=[this.zpx,this.slo,this.rmw],this.lookup[24]=[this.imp,this.clc],this.lookup[25]=[this.aby,this.ora],this.lookup[26]=[this.imp,this.nop],this.lookup[27]=[this.aby,this.slo,this.rmw],this.lookup[28]=[this.abx,this.nop],this.lookup[29]=[this.abx,this.ora],this.lookup[30]=[this.abxp,this.asl,this.rmw],this.lookup[31]=[this.abx,this.slo,this.rmw],this.lookup[32]=[this.abs,this.jsr],this.lookup[33]=[this.izx,this.and],this.lookup[34]=[this.imp,this.kil],this.lookup[35]=[this.izx,this.rla,this.rmw],this.lookup[36]=[this.zp,this.bit],this.lookup[37]=[this.zp,this.and],this.lookup[38]=[this.zp,this.rol,this.rmw],this.lookup[39]=[this.zp,this.rla,this.rmw],this.lookup[40]=[this.imp,this.plp],this.lookup[41]=[this.imm,this.and],this.lookup[42]=[this.imp,this.rla],this.lookup[43]=[this.imm,this.anc],this.lookup[44]=[this.abs,this.bit],this.lookup[45]=[this.abs,this.and],this.lookup[46]=[this.abs,this.rol,this.rmw],this.lookup[47]=[this.abs,this.rla,this.rmw],this.lookup[48]=[this.rel,this.bmi],this.lookup[49]=[this.izy,this.and],this.lookup[50]=[this.imp,this.kil],this.lookup[51]=[this.izy,this.rla,this.rmw],this.lookup[52]=[this.zpx,this.nop],this.lookup[53]=[this.zpx,this.and],this.lookup[54]=[this.zpx,this.rol,this.rmw],this.lookup[55]=[this.zpx,this.rla,this.rmw],this.lookup[56]=[this.imp,this.sec],this.lookup[57]=[this.aby,this.and],this.lookup[58]=[this.imp,this.nop],this.lookup[59]=[this.aby,this.rla,this.rmw],this.lookup[60]=[this.abx,this.nop],this.lookup[61]=[this.abx,this.and],this.lookup[62]=[this.abxp,this.rol,this.rmw],this.lookup[63]=[this.abx,this.rla,this.rmw],this.lookup[64]=[this.imp,this.rti],this.lookup[65]=[this.izx,this.eor],this.lookup[66]=[this.imp,this.kil],this.lookup[67]=[this.izx,this.sre,this.rmw],this.lookup[68]=[this.zp,this.nop],this.lookup[69]=[this.zp,this.eor],this.lookup[70]=[this.zp,this.lsr,this.rmw],this.lookup[71]=[this.zp,this.sre,this.rmw],this.lookup[72]=[this.imp,this.pha],this.lookup[73]=[this.imm,this.eor],this.lookup[74]=[this.imp,this.lsra],this.lookup[75]=[this.imm,this.alr],this.lookup[76]=[this.abs,this.jmp],this.lookup[77]=[this.abs,this.eor],this.lookup[78]=[this.abs,this.lsr,this.rmw],this.lookup[79]=[this.abs,this.sre,this.rmw],this.lookup[80]=[this.rel,this.bvc],this.lookup[81]=[this.izy,this.eor],this.lookup[82]=[this.imp,this.kil],this.lookup[83]=[this.izy,this.sre,this.rmw],this.lookup[84]=[this.zpx,this.nop],this.lookup[85]=[this.zpx,this.eor],this.lookup[86]=[this.zpx,this.lsr,this.rmw],this.lookup[87]=[this.zpx,this.sre,this.rmw],this.lookup[88]=[this.imp,this.cli],this.lookup[89]=[this.aby,this.eor],this.lookup[90]=[this.imp,this.nop],this.lookup[91]=[this.aby,this.sre,this.rmw],this.lookup[92]=[this.abx,this.nop],this.lookup[93]=[this.abx,this.eor],this.lookup[94]=[this.abxp,this.lsr,this.rmw],this.lookup[95]=[this.abx,this.sre,this.rmw],this.lookup[96]=[this.imp,this.rts],this.lookup[97]=[this.izx,this.adc],this.lookup[98]=[this.imp,this.kil],this.lookup[99]=[this.izx,this.rra,this.rmw],this.lookup[100]=[this.zp,this.nop],this.lookup[101]=[this.zp,this.adc],this.lookup[102]=[this.zp,this.ror,this.rmw],this.lookup[103]=[this.zp,this.rra,this.rmw],this.lookup[104]=[this.imp,this.pla],this.lookup[105]=[this.imm,this.adc],this.lookup[106]=[this.imp,this.rra],this.lookup[107]=[this.imm,this.arr],this.lookup[108]=[this.ind,this.jmp],this.lookup[109]=[this.abs,this.adc],this.lookup[110]=[this.abs,this.ror,this.rmw],this.lookup[111]=[this.abs,this.rra,this.rmw],this.lookup[112]=[this.rel,this.bvs],this.lookup[113]=[this.izy,this.adc],this.lookup[114]=[this.imp,this.kil],this.lookup[115]=[this.izy,this.rra,this.rmw],this.lookup[116]=[this.zpx,this.nop],this.lookup[117]=[this.zpx,this.adc],this.lookup[118]=[this.zpx,this.ror,this.rmw],this.lookup[119]=[this.zpx,this.rra,this.rmw],this.lookup[120]=[this.imp,this.sei],this.lookup[121]=[this.aby,this.adc],this.lookup[122]=[this.imp,this.nop],this.lookup[123]=[this.aby,this.rra,this.rmw],this.lookup[124]=[this.abx,this.nop],this.lookup[125]=[this.abx,this.adc],this.lookup[126]=[this.abxp,this.ror,this.rmw],this.lookup[127]=[this.abx,this.rra,this.rmw],this.lookup[128]=[this.imm,this.nop],this.lookup[129]=[this.izx,this.sta],this.lookup[130]=[this.imm,this.nop],this.lookup[131]=[this.izx,this.imp],this.lookup[132]=[this.zp,this.sty],this.lookup[133]=[this.zp,this.sta],this.lookup[134]=[this.zp,this.stx],this.lookup[135]=[this.zp,this.imp],this.lookup[136]=[this.imp,this.dey],this.lookup[137]=[this.imm,this.nop],this.lookup[138]=[this.imp,this.txa],this.lookup[139]=[this.imm,this.imp],this.lookup[140]=[this.abs,this.sty],this.lookup[141]=[this.abs,this.sta],this.lookup[142]=[this.abs,this.stx],this.lookup[143]=[this.abs,this.imp],this.lookup[144]=[this.rel,this.bcc],this.lookup[145]=[this.izyp,this.sta],this.lookup[146]=[this.imp,this.kil],this.lookup[147]=[this.izy,this.ahx],this.lookup[148]=[this.zpx,this.sty],this.lookup[149]=[this.zpx,this.sta],this.lookup[150]=[this.zpy,this.stx],this.lookup[151]=[this.zpy,this.imp],this.lookup[152]=[this.imp,this.tya],this.lookup[153]=[this.abyp,this.sta],this.lookup[154]=[this.imp,this.txs],this.lookup[155]=[this.aby,this.imp],this.lookup[156]=[this.abx,this.shy],this.lookup[157]=[this.abxp,this.sta],this.lookup[158]=[this.aby,this.shx],this.lookup[159]=[this.aby,this.ahx],this.lookup[160]=[this.imm,this.ldy],this.lookup[161]=[this.izx,this.lda],this.lookup[162]=[this.imm,this.ldx],this.lookup[163]=[this.izx,this.lax],this.lookup[164]=[this.zp,this.ldy],this.lookup[165]=[this.zp,this.lda],this.lookup[166]=[this.zp,this.ldx],this.lookup[167]=[this.zp,this.lax],this.lookup[168]=[this.imp,this.tay],this.lookup[169]=[this.imm,this.lda],this.lookup[170]=[this.imp,this.tax],this.lookup[171]=[this.imm,this.lax],this.lookup[172]=[this.abs,this.ldy],this.lookup[173]=[this.abs,this.lda],this.lookup[174]=[this.abs,this.ldx],this.lookup[175]=[this.abs,this.lax],this.lookup[176]=[this.rel,this.bcs],this.lookup[177]=[this.izy,this.lda],this.lookup[178]=[this.imp,this.kil],this.lookup[179]=[this.izy,this.lax],this.lookup[180]=[this.zpx,this.ldy],this.lookup[181]=[this.zpx,this.lda],this.lookup[182]=[this.zpy,this.ldx],this.lookup[183]=[this.zpy,this.lax],this.lookup[184]=[this.imp,this.clv],this.lookup[185]=[this.aby,this.lda],this.lookup[186]=[this.imp,this.tsx],this.lookup[187]=[this.aby,this.las],this.lookup[188]=[this.abx,this.ldy],this.lookup[189]=[this.abx,this.lda],this.lookup[190]=[this.aby,this.ldx],this.lookup[191]=[this.aby,this.lax],this.lookup[192]=[this.imm,this.cpy],this.lookup[193]=[this.izx,this.cmp],this.lookup[194]=[this.imm,this.nop],this.lookup[195]=[this.izx,this.dcp,this.rmw],this.lookup[196]=[this.zp,this.cpy],this.lookup[197]=[this.zp,this.cmp],this.lookup[198]=[this.zp,this.dec,this.rmw],this.lookup[199]=[this.zp,this.dcp,this.rmw],this.lookup[200]=[this.imp,this.iny],this.lookup[201]=[this.imm,this.cmp],this.lookup[202]=[this.imp,this.dex],this.lookup[203]=[this.imm,this.axs],this.lookup[204]=[this.abs,this.cpy],this.lookup[205]=[this.abs,this.cmp],this.lookup[206]=[this.abs,this.dec,this.rmw],this.lookup[207]=[this.abs,this.dcp,this.rmw],this.lookup[208]=[this.rel,this.bne],this.lookup[209]=[this.izy,this.cmp],this.lookup[210]=[this.imp,this.kil],this.lookup[211]=[this.izy,this.dcp,this.rmw],this.lookup[212]=[this.zpx,this.nop],this.lookup[213]=[this.zpx,this.cmp],this.lookup[214]=[this.zpx,this.dec,this.rmw],this.lookup[215]=[this.zpx,this.dcp,this.rmw],this.lookup[216]=[this.imp,this.cld],this.lookup[217]=[this.aby,this.cmp],this.lookup[218]=[this.imp,this.nop],this.lookup[219]=[this.aby,this.dcp,this.rmw],this.lookup[220]=[this.abx,this.nop],this.lookup[221]=[this.abx,this.cmp],this.lookup[222]=[this.abxp,this.dec,this.rmw],this.lookup[223]=[this.abx,this.dcp,this.rmw],this.lookup[224]=[this.imm,this.cpx],this.lookup[225]=[this.izx,this.sbc],this.lookup[226]=[this.imm,this.nop],this.lookup[227]=[this.izx,this.isc,this.rmw],this.lookup[228]=[this.zp,this.cpx],this.lookup[229]=[this.zp,this.sbc],this.lookup[230]=[this.zp,this.inc,this.rmw],this.lookup[231]=[this.zp,this.isc,this.rmw],this.lookup[232]=[this.imp,this.inx],this.lookup[233]=[this.imm,this.sbc],this.lookup[234]=[this.imp,this.nop],this.lookup[235]=[this.imm,this.sbc],this.lookup[236]=[this.abs,this.cpx],this.lookup[237]=[this.abs,this.sbc],this.lookup[238]=[this.abs,this.inc,this.rmw],this.lookup[239]=[this.abs,this.isc,this.rmw],this.lookup[240]=[this.rel,this.beq],this.lookup[241]=[this.izy,this.sbc],this.lookup[242]=[this.imp,this.kil],this.lookup[243]=[this.izy,this.isc,this.rmw],this.lookup[244]=[this.zpx,this.nop],this.lookup[245]=[this.zpx,this.sbc],this.lookup[246]=[this.zpx,this.inc,this.rmw],this.lookup[247]=[this.zpx,this.isc,this.rmw],this.lookup[248]=[this.imp,this.sed],this.lookup[249]=[this.aby,this.sbc],this.lookup[250]=[this.imp,this.nop],this.lookup[251]=[this.aby,this.isc,this.rmw],this.lookup[252]=[this.abx,this.nop],this.lookup[253]=[this.abx,this.sbc],this.lookup[254]=[this.abxp,this.inc,this.rmw],this.lookup[255]=[this.abx,this.isc,this.rmw],this.ASMlookup=[["brk",this.brk,this.imm,7],["ora",this.ora,this.izx,6],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,3],["ora",this.ora,this.zp,3],["asl",this.asl,this.zp,5],["???",this.xxx,this.imp,5],["php",this.php,this.imp,3],["ora",this.ora,this.imm,2],["asl",this.asl,this.imp,2],["???",this.xxx,this.imp,2],["???",this.nop,this.imp,4],["ora",this.ora,this.abs,4],["asl",this.asl,this.abs,6],["???",this.xxx,this.imp,6],["bpl",this.bpl,this.rel,2],["ora",this.ora,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,4],["ora",this.ora,this.zpx,4],["asl",this.asl,this.zpx,6],["???",this.xxx,this.imp,6],["clc",this.clc,this.imp,2],["ora",this.ora,this.aby,4],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,4],["ora",this.ora,this.abx,4],["asl",this.asl,this.abx,7],["???",this.xxx,this.imp,7],["jsr",this.jsr,this.abs,6],["and",this.and,this.izx,6],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["bit",this.bit,this.zp,3],["and",this.and,this.zp,3],["rol",this.rol,this.zp,5],["???",this.xxx,this.imp,5],["plp",this.plp,this.imp,4],["and",this.and,this.imm,2],["rol",this.rol,this.imp,2],["???",this.xxx,this.imp,2],["bit",this.bit,this.abs,4],["and",this.and,this.abs,4],["rol",this.rol,this.abs,6],["???",this.xxx,this.imp,6],["bmi",this.bmi,this.rel,2],["and",this.and,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,4],["and",this.and,this.zpx,4],["rol",this.rol,this.zpx,6],["???",this.xxx,this.imp,6],["sec",this.sec,this.imp,2],["and",this.and,this.aby,4],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,4],["and",this.and,this.abx,4],["rol",this.rol,this.abx,7],["???",this.xxx,this.imp,7],["rti",this.rti,this.imp,6],["eor",this.eor,this.izx,6],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,3],["eor",this.eor,this.zp,3],["lsr",this.lsr,this.zp,5],["???",this.xxx,this.imp,5],["pha",this.pha,this.imp,3],["eor",this.eor,this.imm,2],["lsr",this.lsr,this.imp,2],["???",this.xxx,this.imp,2],["jmp",this.jmp,this.abs,3],["eor",this.eor,this.abs,4],["lsr",this.lsr,this.abs,6],["???",this.xxx,this.imp,6],["bvc",this.bvc,this.rel,2],["eor",this.eor,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,4],["eor",this.eor,this.zpx,4],["lsr",this.lsr,this.zpx,6],["???",this.xxx,this.imp,6],["cli",this.cli,this.imp,2],["eor",this.eor,this.aby,4],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,4],["eor",this.eor,this.abx,4],["lsr",this.lsr,this.abx,7],["???",this.xxx,this.imp,7],["rts",this.rts,this.imp,6],["adc",this.adc,this.izx,6],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,3],["adc",this.adc,this.zp,3],["ror",this.ror,this.zp,5],["???",this.xxx,this.imp,5],["pla",this.pla,this.imp,4],["adc",this.adc,this.imm,2],["ror",this.ror,this.imp,2],["???",this.xxx,this.imp,2],["jmp",this.jmp,this.ind,5],["adc",this.adc,this.abs,4],["ror",this.ror,this.abs,6],["???",this.xxx,this.imp,6],["bvs",this.bvs,this.rel,2],["adc",this.adc,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,4],["adc",this.adc,this.zpx,4],["ror",this.ror,this.zpx,6],["???",this.xxx,this.imp,6],["sei",this.sei,this.imp,2],["adc",this.adc,this.aby,4],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,4],["adc",this.adc,this.abx,4],["ror",this.ror,this.abx,7],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,2],["sta",this.sta,this.izx,6],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,6],["sty",this.sty,this.zp,3],["sta",this.sta,this.zp,3],["stx",this.stx,this.zp,3],["???",this.xxx,this.imp,3],["dey",this.dey,this.imp,2],["???",this.nop,this.imp,2],["txa",this.txa,this.imp,2],["???",this.xxx,this.imp,2],["sty",this.sty,this.abs,4],["sta",this.sta,this.abs,4],["stx",this.stx,this.abs,4],["???",this.xxx,this.imp,4],["bcc",this.bcc,this.rel,2],["sta",this.sta,this.izy,6],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,6],["sty",this.sty,this.zpx,4],["sta",this.sta,this.zpx,4],["stx",this.stx,this.zpy,4],["???",this.xxx,this.imp,4],["tya",this.tya,this.imp,2],["sta",this.sta,this.aby,5],["txs",this.txs,this.imp,2],["???",this.xxx,this.imp,5],["???",this.nop,this.imp,5],["sta",this.sta,this.abx,5],["???",this.xxx,this.imp,5],["???",this.xxx,this.imp,5],["ldy",this.ldy,this.imm,2],["lda",this.lda,this.izx,6],["ldx",this.ldx,this.imm,2],["???",this.xxx,this.imp,6],["ldy",this.ldy,this.zp,3],["lda",this.lda,this.zp,3],["ldx",this.ldx,this.zp,3],["???",this.xxx,this.imp,3],["tay",this.tay,this.imp,2],["lda",this.lda,this.imm,2],["tax",this.tax,this.imp,2],["???",this.xxx,this.imp,2],["ldy",this.ldy,this.abs,4],["lda",this.lda,this.abs,4],["ldx",this.ldx,this.abs,4],["???",this.xxx,this.imp,4],["bcs",this.bcs,this.rel,2],["lda",this.lda,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,5],["ldy",this.ldy,this.zpx,4],["lda",this.lda,this.zpx,4],["ldx",this.ldx,this.zpy,4],["???",this.xxx,this.imp,4],["clv",this.clv,this.imp,2],["lda",this.lda,this.aby,4],["tsx",this.tsx,this.imp,2],["???",this.xxx,this.imp,4],["ldy",this.ldy,this.abx,4],["lda",this.lda,this.abx,4],["ldx",this.ldx,this.aby,4],["???",this.xxx,this.imp,4],["cpy",this.cpy,this.imm,2],["cmp",this.cmp,this.izx,6],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,8],["cpy",this.cpy,this.zp,3],["cmp",this.cmp,this.zp,3],["dec",this.dec,this.zp,5],["???",this.xxx,this.imp,5],["iny",this.iny,this.imp,2],["cmp",this.cmp,this.imm,2],["dex",this.dex,this.imp,2],["???",this.xxx,this.imp,2],["cpy",this.cpy,this.abs,4],["cmp",this.cmp,this.abs,4],["dec",this.dec,this.abs,6],["???",this.xxx,this.imp,6],["bne",this.bne,this.rel,2],["cmp",this.cmp,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,4],["cmp",this.cmp,this.zpx,4],["dec",this.dec,this.zpx,6],["???",this.xxx,this.imp,6],["cld",this.cld,this.imp,2],["cmp",this.cmp,this.aby,4],["nop",this.nop,this.imp,2],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,4],["cmp",this.cmp,this.abx,4],["dec",this.dec,this.abx,7],["???",this.xxx,this.imp,7],["cpx",this.cpx,this.imm,2],["sbc",this.sbc,this.izx,6],["???",this.nop,this.imp,2],["???",this.xxx,this.imp,8],["cpx",this.cpx,this.zp,3],["sbc",this.sbc,this.zp,3],["inc",this.inc,this.zp,5],["???",this.xxx,this.imp,5],["inx",this.inx,this.imp,2],["sbc",this.sbc,this.imm,2],["nop",this.nop,this.imp,2],["???",this.sbc,this.imp,2],["cpx",this.cpx,this.abs,4],["sbc",this.sbc,this.abs,4],["inc",this.inc,this.abs,6],["???",this.xxx,this.imp,6],["beq",this.beq,this.rel,2],["sbc",this.sbc,this.izy,5],["???",this.xxx,this.imp,2],["???",this.xxx,this.imp,8],["???",this.nop,this.imp,4],["sbc",this.sbc,this.zpx,4],["inc",this.inc,this.zpx,6],["???",this.xxx,this.imp,6],["sed",this.sed,this.imp,2],["sbc",this.sbc,this.aby,4],["nop",this.nop,this.imp,2],["???",this.xxx,this.imp,7],["???",this.nop,this.imp,4],["sbc",this.sbc,this.abx,4],["inc",this.inc,this.abx,7],["???",this.xxx,this.imp,7]],this.ASMlookup=this.ASMlookup.map((function(t){return{name:t[0],operate:t[1],addrmode:t[2],cycles:t[3]}}))}var i,s,h;return i=t,(s=[{key:"GetFlag",value:function(t){return t===olc6502.FLAGS6502.U?this.U:t===olc6502.FLAGS6502.B?this.B:t===olc6502.FLAGS6502.C?this.C:t===olc6502.FLAGS6502.D?this.D:t===olc6502.FLAGS6502.I?this.I:void 0}},{key:"ConnectBus",value:function(t){this.bus=t,t.cpu=this}},{key:"complete",value:function(){return 0===this.cycles}},{key:"irq",value:function(){if(0===this.I){this.write(256+this.S,this.pc>>8&255),this.S--,this.write(256+this.S,255&this.pc),this.S--,this.B=0,this.U=1,this.I=1;var t=this.N<<7;t|=this.V<<6,t|=48,t|=this.D<<3,t|=this.I<<2,t|=this.Z<<1,t|=this.C,this.write(256+this.S,t),this.S--,this.addr=65534;var i=this.read(this.addr+0),s=this.read(this.addr+1);this.pc=s<<8|i,this.cycles=7}}},{key:"nmi",value:function(){this.write(256+this.S,this.pc>>8&255),this.S--,this.write(256+this.S,255&this.pc),this.S--,this.B=0,this.U=1,this.I=1;var t=this.N<<7;t|=this.V<<6,t|=48,t|=this.D<<3,t|=this.I<<2,t|=this.Z<<1,t|=this.C,this.write(256+this.S,t),this.S--,this.addr=65530;var i=this.read(this.addr+0),s=this.read(this.addr+1);this.pc=s<<8|i,this.cycles=8}},{key:"disassemble",value:function(t,i){for(var s=t,h=0,e=0,r=0,a=[],n=0,o=function(t,i){for(var s=[],h=i-1;h>=0;h--,t>>=4)s[h]="0123456789ABCDEF"[15&t];return s.join("")};s<=i;){n=s;var p="$"+o(s,4)+": ",l=this.bus.cpuRead(s,!0)||0;s++,p+=this.ASMlookup[l].name+" ",this.ASMlookup[l].addrmode===this.imp?p+=" {IMP}":this.ASMlookup[l].addrmode===this.imm?(h=this.bus.cpuRead(s,!0),s++,p+="#$"+o(h,2)+" {IMM}"):this.ASMlookup[l].addrmode===this.zp?(e=this.bus.cpuRead(s,!0),s++,r=0,p+="$"+o(e,2)+" {zp }"):this.ASMlookup[l].addrmode===this.zpx?(e=this.bus.cpuRead(s,!0),s++,r=0,p+="$"+o(e,2)+", X {ZPX}"):this.ASMlookup[l].addrmode===this.zpy?(e=this.bus.cpuRead(s,!0),s++,r=0,p+="$"+o(e,2)+", Y {ZPY}"):this.ASMlookup[l].addrmode===this.izx?(e=this.bus.cpuRead(s,!0),s++,r=0,p+="($"+o(e,2)+", X) {IZX}"):this.ASMlookup[l].addrmode===this.izy?(e=this.bus.cpuRead(s,!0),s++,r=0,p+="($"+o(e,2)+"), Y {IZY}"):this.ASMlookup[l].addrmode===this.abs?(e=this.bus.cpuRead(s,!0),s++,r=this.bus.cpuRead(s,!0),s++,p+="$"+o(r<<8|e,4)+" {ABS}"):this.ASMlookup[l].addrmode===this.abx?(e=this.bus.cpuRead(s,!0),s++,r=this.bus.cpuRead(s,!0),s++,p+="$"+o(r<<8|e,4)+", X {ABX}"):this.ASMlookup[l].addrmode===this.aby?(e=this.bus.cpuRead(s,!0),s++,r=this.bus.cpuRead(s,!0),s++,p+="$"+o(r<<8|e,4)+", Y {ABY}"):this.ASMlookup[l].addrmode===this.ind?(e=this.bus.cpuRead(s,!0),s++,r=this.bus.cpuRead(s,!0),s++,p+="($"+o(r<<8|e,4)+") {IND}"):this.ASMlookup[l].addrmode===this.rel&&(h=this.bus.cpuRead(s,!0),s++,p+="$"+o(h,2)+" [$"+o(s+h,4)+"] {REL}"),a[n]=p}return a}},{key:"reset",value:function(){this.A=0,this.X=0,this.Y=0,this.S=0,this.N=0,this.Z=1,this.C=0,this.V=0,this.I=0,this.D=0,this.pc=this.read(65533)<<8|this.read(65532)}},{key:"step",value:function(){this.opcode=this.read(this.pc++),this.lookup[this.opcode].operate.bind(this),this.lookup[this.opcode].addrmode.bind(this)}},{key:"clock",value:function(){if(0===this.cycles){for(var t in this.opcode=this.read(this.pc++)||0,this.U=1,this.lookup[this.opcode])try{this.lookup[this.opcode][t].bind(this)()}catch(t){}this.U=1}this.clock_count++,this.cycles--}},{key:"log",value:function(){this.pc.toString(16),this.cycles,this.opcode.toString(16),this.C,this.N,this.Z,this.V,this.D,this.I,this.A.toString(16),this.X.toString(16),this.Y.toString(16),this.S.toString(16)}},{key:"read",value:function(t){return this.bus.cpuRead(t,!1)}},{key:"write",value:function(t,i){this.bus.cpuWrite(t,i)}},{key:"kil",value:function(){return 0}},{key:"izx",value:function(){var t=this.read(this.pc++)+this.X&255;this.addr=this.read(t+1&255)<<8|this.read(t),this.cycles+=6}},{key:"izy",value:function(){var t=this.read(this.pc++),i=this.read(255&t),s=this.read(t+1&255);this.addr=s<<8|i,this.addr=this.addr+this.Y&65535,(65280&this.addr)!=s<<8?this.cycles+=6:this.cycles+=5}},{key:"izyp",value:function(){var t=this.read(this.pc++),i=this.read(t+1&255)<<8|this.read(t);this.addr=i+this.Y,this.cycles+=6}},{key:"ind",value:function(){var t=this.read(this.pc++);t|=this.read(this.pc++)<<8,this.addr=this.read(t),this.addr|=this.read(65280&t|t+1&255)<<8,this.cycles+=6}},{key:"zp",value:function(){this.addr=this.read(this.pc++),this.cycles+=3}},{key:"zpx",value:function(){this.addr=this.read(this.pc++)+this.X&255,this.cycles+=4}},{key:"zpy",value:function(){this.addr=this.read(this.pc++)+this.Y&255,this.cycles+=4}},{key:"imp",value:function(){this.cycles+=2}},{key:"imm",value:function(){this.addr=this.pc++,this.cycles+=2}},{key:"abs",value:function(){this.addr=this.read(this.pc++),this.addr|=this.read(this.pc++)<<8,this.cycles+=4}},{key:"abx",value:function(){var t=this.read(this.pc++);t|=this.read(this.pc++)<<8,this.addr=t+this.X,(256&t)!=(256&this.addr)?this.cycles+=5:this.cycles+=4}},{key:"abxp",value:function(){var t=this.read(this.pc++);t|=this.read(this.pc++)<<8,this.addr=t+this.X,this.cycles+=5}},{key:"aby",value:function(){var t=this.read(this.pc++);t|=this.read(this.pc++)<<8,this.addr=t+this.Y&65535,(256&t)!=(256&this.addr)?this.cycles+=5:this.cycles+=4}},{key:"abyp",value:function(){var t=this.read(this.pc++);t|=this.read(this.pc++)<<8,this.addr=t+this.Y&65535,this.cycles+=5}},{key:"rel",value:function(){this.addr=this.read(this.pc++),128&this.addr&&(this.addr-=256),this.addr+=this.pc,this.cycles+=2}},{key:"rmw",value:function(){this.write(this.addr,255&this.tmp),this.cycles+=2}},{key:"fnz",value:function(t){this.Z=0==(255&t)?1:0,this.N=0!=(128&t)?1:0}},{key:"fnzb",value:function(t){this.Z=0==(255&t)?1:0,this.N=0!=(128&t)?1:0,this.C=0!=(256&t)?0:1}},{key:"fnzc",value:function(t){this.Z=0==(255&t)?1:0,this.N=0!=(128&t)?1:0,this.C=0!=(256&t)?1:0}},{key:"branch",value:function(t){t&&((256&this.addr)!=(256&this.pc)?this.cycles+=2:this.cycles+=1,this.pc=this.addr)}},{key:"adc",value:function(){var t=this.read(this.addr),i=this.C,s=this.A+t+i;this.Z=0==(255&s)?1:0,this.N=0!=(128&s)?1:0,this.V=0!=(~(this.A^t)&(this.A^s)&128)?1:0,this.C=0!=(256&s)?1:0,this.A=255&s}},{key:"ahx",value:function(){this.tmp=1+(this.addr>>8)&this.A&this.X,this.write(this.addr,255&this.tmp)}},{key:"alr",value:function(){this.tmp=this.read(this.addr)&this.A,this.tmp=(1&this.tmp)<<8|this.tmp>>1,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"anc",value:function(){this.tmp=this.read(this.addr),this.tmp|=(128&this.tmp&this.A)<<1,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"and",value:function(){this.A&=this.read(this.addr),this.fnz(this.A)}},{key:"ane",value:function(){this.tmp=this.read(this.addr)&this.A&(238|this.A),this.fnz(this.tmp),this.A=255&this.tmp}},{key:"arr",value:function(){if(this.tmp=this.read(this.adfdr)&this.A,this.C=0!=(128&this.tmp),this.V=0!=(this.tmp>>7&1^this.tmp>>6&1),this.D){var t=(15&this.tmp)+(1&this.tmp);t>5&&(t+=6);var i=(this.tmp>>4&15)+(this.tmp>>4&1);i>5?(t+=6,this.C=!0):this.C=!1,this.tmp=i<<4|t}this.fnz(this.tmp),this.A=255&this.tmp}},{key:"asl",value:function(){this.tmp=this.read(this.addr)<<1,this.fnzc(this.tmp),this.tmp&=255}},{key:"asla",value:function(){this.tmp=this.A<<1,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"bit",value:function(){this.tmp=this.read(this.addr),this.N=0!=(128&this.tmp)?1:0,this.V=0!=(64&this.tmp)?1:0,this.Z=0==(this.tmp&this.A)?1:0}},{key:"brk",value:function(){this.pc++,this.write(this.S+256,this.pc>>8),this.S=this.S-1&255,this.write(this.S+256,255&this.pc),this.S=this.S-1&255;var t=this.N<<7;t|=this.V<<6,t|=48,t|=this.D<<3,t|=this.I<<2,t|=this.Z<<1,t|=this.C,this.write(this.S+256,t),this.S=this.S-1&255,this.I=1,this.D=0,this.pc=this.read(65535)<<8|this.read(65534),this.cycles+=5}},{key:"bcc",value:function(){this.branch(0==this.C)}},{key:"bcs",value:function(){this.branch(1==this.C)}},{key:"beq",value:function(){this.branch(1==this.Z)}},{key:"bne",value:function(){this.branch(0==this.Z)}},{key:"bmi",value:function(){this.branch(1==this.N)}},{key:"bpl",value:function(){this.branch(0==this.N)}},{key:"bvc",value:function(){this.branch(0==this.V)}},{key:"bvs",value:function(){this.branch(1==this.V)}},{key:"clc",value:function(){this.C=0}},{key:"cld",value:function(){this.D=0}},{key:"cli",value:function(){this.I=0}},{key:"clv",value:function(){this.V=0}},{key:"cmp",value:function(){this.fnzb(this.A-this.read(this.addr))}},{key:"cpx",value:function(){this.fnzb(this.X-this.read(this.addr))}},{key:"cpy",value:function(){this.fnzb(this.Y-this.read(this.addr))}},{key:"dcp",value:function(){this.tmp=this.read(this.addr)-1&255,this.tmp=this.A-this.tmp,this.fnz(this.tmp)}},{key:"dec",value:function(){this.tmp=this.read(this.addr)-1&255,this.fnz(this.tmp)}},{key:"dex",value:function(){this.X=this.X-1&255,this.fnz(this.X)}},{key:"dey",value:function(){this.Y=this.Y-1&255,this.fnz(this.Y)}},{key:"eor",value:function(){this.A^=this.read(this.addr),this.fnz(this.A)}},{key:"inc",value:function(){this.tmp=this.read(this.addr)+1&255,this.fnz(this.tmp)}},{key:"inx",value:function(){this.X=this.X+1&255,this.fnz(this.X)}},{key:"iny",value:function(){this.Y=this.Y+1&255,this.fnz(this.Y)}},{key:"isc",value:function(){var t=this.read(this.addr)+1&255,i=1-(this.C?1:0),s=this.A-t-i;if(this.D){var h=(15&this.A)-(15&t)-i;h>128&&(h-=6);var e=(this.A>>4)-(t>>4)-(h>128?1:0);this.Z=0==(255&s),this.N=0!=(128&s),this.V=0!=((this.A^t)&(this.A^s)&128),this.C=0!=(256&this.r)?0:1,e>128&&(e-=6),this.A=255&(e<<4|15&h)}else this.Z=0==(255&s),this.N=0!=(128&s),this.V=0!=((this.A^t)&(this.A^s)&128),this.C=0!=(256&s)?0:1,this.A=255&s}},{key:"jmp",value:function(){this.pc=this.addr,this.cycles--}},{key:"jsr",value:function(){this.write(this.S+256,this.pc-1>>8),this.S=this.S-1&255,this.write(this.S+256,this.pc-1&255),this.S=this.S-1&255,this.pc=this.addr,this.cycles+=2}},{key:"las",value:function(){this.S=this.X=this.A=this.read(this.addr)&this.S,this.fnz(this.A)}},{key:"lax",value:function(){this.X=this.A=this.read(this.addr),this.fnz(this.A)}},{key:"lda",value:function(){this.A=this.read(this.addr),this.fnz(this.A)}},{key:"ldx",value:function(){this.X=this.read(this.addr),this.fnz(this.X)}},{key:"ldy",value:function(){this.Y=this.read(this.addr),this.fnz(this.Y)}},{key:"ora",value:function(){this.A|=this.read(this.addr),this.fnz(this.A)}},{key:"rol",value:function(){this.tmp=this.read(this.addr)<<1|this.C,this.fnzc(this.tmp),this.tmp&=255}},{key:"rla",value:function(){this.tmp=this.A<<1|this.C,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"ror",value:function(){this.tmp=this.read(this.addr),this.tmp=(1&this.tmp)<<8|this.C<<7|this.tmp>>1,this.fnzc(this.tmp),this.tmp&=255}},{key:"rra",value:function(){this.tmp=(1&this.A)<<8|this.C<<7|this.A>>1,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"lsr",value:function(){this.tmp=this.read(this.addr),this.tmp=(1&this.tmp)<<8|this.tmp>>1,this.fnzc(this.tmp),this.tmp&=255}},{key:"lsra",value:function(){this.tmp=(1&this.A)<<8|this.A>>1,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"nop",value:function(){}},{key:"pha",value:function(){this.write(this.S+256,this.A),this.S=this.S-1&255,this.cycles++}},{key:"php",value:function(){var t=this.N<<7;t|=this.V<<6,t|=48,t|=this.D<<3,t|=this.I<<2,t|=this.Z<<1,t|=this.C,this.write(this.S+256,t),this.S=this.S-1&255,this.cycles++}},{key:"pla",value:function(){this.S=this.S+1&255,this.A=this.read(this.S+256),this.fnz(this.A),this.cycles+=2}},{key:"plp",value:function(){this.S=this.S+1&255,this.tmp=this.read(this.S+256),this.N=0!=(128&this.tmp)?1:0,this.V=0!=(64&this.tmp)?1:0,this.D=0!=(8&this.tmp)?1:0,this.I=0!=(4&this.tmp)?1:0,this.Z=0!=(2&this.tmp)?1:0,this.C=0!=(1&this.tmp)?1:0,this.cycles+=2}},{key:"rti",value:function(){this.S=this.S+1&255,this.tmp=this.read(this.S+256),this.N=0!=(128&this.tmp)?1:0,this.V=0!=(64&this.tmp)?1:0,this.D=0!=(8&this.tmp)?1:0,this.I=0!=(4&this.tmp)?1:0,this.Z=0!=(2&this.tmp)?1:0,this.C=0!=(1&this.tmp)?1:0,this.S=this.S+1&255,this.pc=this.read(this.S+256),this.S=this.S+1&255,this.pc|=this.read(this.S+256)<<8,this.cycles+=4}},{key:"rts",value:function(){this.S=this.S+1&255,this.pc=this.read(this.S+256),this.S=this.S+1&255,this.pc|=this.read(this.S+256)<<8,this.pc++,this.cycles+=4}},{key:"sbc",value:function(){var t=this.read(this.addr),i=1-this.C,s=this.A-t-i;if(this.D){var h=(15&this.A)-(15&t)-i;h<0&&(h-=6);var e=(this.A>>4)-(t>>4)-(h<0?1:0);this.Z=0==(255&s)?1:0,this.N=0!=(128&s)?1:0,this.V=0!=((this.A^t)&(this.A^s)&128)?1:0,this.C=0!=(256&s)?0:1,e<0&&(e-=6),this.A=255&(e<<4|15&h)}else this.Z=0==(255&s)?1:0,this.N=0!=(128&s)?1:0,this.V=0!=((this.A^t)&(this.A^s)&128)?1:0,this.C=0!=(256&s)?0:1,this.A=255&s}},{key:"sbx",value:function(){this.tmp=this.read(this.addr)-(this.A&this.X),this.fnzb(this.tmp),this.X=255&this.tmp}},{key:"sec",value:function(){this.C=1}},{key:"sed",value:function(){this.D=1}},{key:"sei",value:function(){this.I=1}},{key:"shs",value:function(){this.tmp=1+(this.addr>>8)&this.A&this.X,this.write(this.addr,255&this.tmp),this.S=255&this.tmp}},{key:"shx",value:function(){this.tmp=1+(this.addr>>8)&this.X,this.write(this.addr,255&this.tmp)}},{key:"shy",value:function(){this.tmp=1+(this.addr>>8)&this.Y,this.write(this.addr,255&this.tmp)}},{key:"slo",value:function(){this.tmp=this.read(this.addr)<<1,this.tmp|=this.A,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"sre",value:function(){var t=this.read(this.addr);this.tmp=(1&t)<<8|t>>1,this.tmp^=this.A,this.fnzc(this.tmp),this.A=255&this.tmp}},{key:"sta",value:function(){this.write(this.addr,this.A)}},{key:"stx",value:function(){this.write(this.addr,this.X)}},{key:"sty",value:function(){this.write(this.addr,this.Y)}},{key:"tax",value:function(){this.X=this.A,this.fnz(this.X)}},{key:"tay",value:function(){this.Y=this.A,this.fnz(this.Y)}},{key:"tsx",value:function(){this.X=this.S,this.fnz(this.X)}},{key:"txa",value:function(){this.A=this.X,this.fnz(this.A)}},{key:"txs",value:function(){this.S=this.X}},{key:"tya",value:function(){this.A=this.Y,this.fnz(this.A)}},{key:"xxx",value:function(){return 0}}])&&N(i.prototype,s),h&&N(i,h),t}();function X(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var Z=function(){function t(i,s,h){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.width=s,this.height=h,"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?postMessage({op:"ctxInit",width:this.width,height:this.height}):this.ctx=i.createImageData(this.width,this.height)}var i,s,h;return i=t,(s=[{key:"FillPixel",value:function(t,i,s){var h=4*(i*this.width+t);this.ctx.data[h]=s.red,this.ctx.data[h+1]=s.green,this.ctx.data[h+2]=s.blue,this.ctx.data[h+3]=255}},{key:"SetPixel",value:function(t,i,s){t>this.width||i>this.height||i<0||this.FillPixel(t,i,s)}}])&&X(i.prototype,s),h&&X(i,h),t}();function W(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var Y=function(){function t(i){var s=this;!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.struct=[],this.totalLength=0,this.bytes=0,Object.keys(i).forEach((function(t){s.totalLength++,s[t]=0,s.bytes+=i[t],s.struct.push({key:t,bytes:i[t]})}))}var i,s,h;return i=t,(s=[{key:"setReg",value:function(t){t=t.toString(2);for(var i=0;i<this.totalLength;i++){var s=t.substring(t.length-this.struct[i].bytes);t=t.substring(0,t.length-this.struct[i].bytes),this[this.struct[i].key]=parseInt(s||0,2)}}},{key:"reg",get:function(){for(var t=0,i=0,s=0;s<this.totalLength;s++)t|=this[this.struct[s].key]<<i,i+=this.struct[s].bytes;return t},set:function(t){for(var i=this.bytes,s=this.totalLength-1;s>=0;s--){var h=t>>(i-=this.struct[s].bytes);t&=~(1<<i),this[this.struct[s].key]=h}}}])&&W(i.prototype,s),h&&W(i,h),t}();function V(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var U=function(){function t(i,s,h){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.red=i,this.green=s,this.blue=h}var i,s,h;return i=t,(s=[{key:"hex",value:function(t,i){for(var s=[],h=i-1;h>=0;h--,t>>=4)s[h]="0123456789ABCDEF"[15&t];return s.join("")}},{key:"getCode",value:function(){return"#"+this.hex(this.red,2)+this.hex(this.green,2)+this.hex(this.blue,2)}}])&&V(i.prototype,s),h&&V(i,h),t}();function $(t,i){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var h=Object.getOwnPropertySymbols(t);i&&(h=h.filter((function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable}))),s.push.apply(s,h)}return s}function q(t){for(var i=1;i<arguments.length;i++){var s=null!=arguments[i]?arguments[i]:{};i%2?$(Object(s),!0).forEach((function(i){J(t,i,s[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):$(Object(s)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(s,i))}))}return t}function J(t,i,s){return i in t?Object.defineProperty(t,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[i]=s,t}function K(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var Q=function(){function t(i){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.vram_addr=null,this.tram_addr={},this.fine_x=0,this.address_latch=0,this.ppu_data_buffer=255,this.scanline=0,this.cycle=0,this.status=new Y({unused:5,sprite_overflow:1,sprite_zero_hit:1,vertical_blank:1}),this.mask=new Y({grayscale:1,render_background_left:1,render_sprites_left:1,render_background:1,render_sprites:1,enhance_red:1,enhance_green:1,enhance_blue:1}),this.control=new Y({nametable_x:1,nametable_y:1,increment_mode:1,pattern_sprite:1,pattern_background:1,sprite_size:1,slave_mode:1,enable_nmi:1}),this.vram_addr=new Y({coarse_x:5,coarse_y:5,nametable_x:1,nametable_y:1,fine_y:3,unused:1}),this.tram_addr=new Y({coarse_x:5,coarse_y:5,nametable_x:1,nametable_y:1,fine_y:3,unused:1}),this.OAM=Array(65);for(var s=0;s<65;s++)this.OAM[s]={};this.bg_next_tile_id=0,this.bg_next_tile_attrib=0,this.bg_next_tile_lsb=0,this.bg_next_tile_msb=0,this.bg_shifter_pattern_lo=0,this.bg_shifter_pattern_hi=0,this.bg_shifter_attrib_lo=0,this.bg_shifter_attrib_hi=0,this.tblName=[Array(4096).fill(0),Array(4096).fill(0)],this.tblPattern=[Array(4096).fill(0),Array(4096).fill(0)],this.tblPalette=[];var h=[];this.sprScreen=new Z(i,370,240),this.sprNameTable=[new Z(i,256,240),new Z(i,256,240)],this.sprPatternTable=[new Z(i,128,128),new Z(i,128,128)],h[0]=new U(84,84,84),h[1]=new U(0,30,116),h[2]=new U(8,16,144),h[3]=new U(48,0,136),h[4]=new U(68,0,100),h[5]=new U(92,0,48),h[6]=new U(84,4,0),h[7]=new U(60,24,0),h[8]=new U(32,42,0),h[9]=new U(8,58,0),h[10]=new U(0,64,0),h[11]=new U(0,60,0),h[12]=new U(0,50,60),h[13]=new U(0,0,0),h[14]=new U(0,0,0),h[15]=new U(0,0,0),h[16]=new U(152,150,152),h[17]=new U(8,76,196),h[18]=new U(48,50,236),h[19]=new U(92,30,228),h[20]=new U(136,20,176),h[21]=new U(160,20,100),h[22]=new U(152,34,32),h[23]=new U(120,60,0),h[24]=new U(84,90,0),h[25]=new U(40,114,0),h[26]=new U(8,124,0),h[27]=new U(0,118,40),h[28]=new U(0,102,120),h[29]=new U(0,0,0),h[30]=new U(0,0,0),h[31]=new U(0,0,0),h[32]=new U(236,238,236),h[33]=new U(76,154,236),h[34]=new U(120,124,236),h[35]=new U(176,98,236),h[36]=new U(228,84,236),h[37]=new U(236,88,180),h[38]=new U(236,106,100),h[39]=new U(212,136,32),h[40]=new U(160,170,0),h[41]=new U(116,196,0),h[42]=new U(76,208,32),h[43]=new U(56,204,108),h[44]=new U(56,180,204),h[45]=new U(60,60,60),h[46]=new U(0,0,0),h[47]=new U(0,0,0),h[48]=new U(236,238,236),h[49]=new U(168,204,236),h[50]=new U(188,188,236),h[51]=new U(212,178,236),h[52]=new U(236,174,236),h[53]=new U(236,174,212),h[54]=new U(236,180,176),h[55]=new U(228,196,144),h[56]=new U(204,210,120),h[57]=new U(180,222,120),h[58]=new U(168,226,144),h[59]=new U(152,226,180),h[60]=new U(160,214,228),h[61]=new U(160,162,160),h[62]=new U(0,0,0),h[63]=new U(0,0,0),this.palScreen=h,this.oam_addr=0,this.spriteScanline=Array(8);for(var e=0;e<8;e++)this.spriteScanline[e]={};this.sprite_count=0,this.sprite_shifter_pattern_lo=[],this.sprite_shifter_pattern_hi=[],this.bSpriteZeroHitPossible=!1,this.bSpriteZeroBeingRendered=!1,this.frame_complete=!1}var i,s,h;return i=t,(s=[{key:"ConnectBus",value:function(t){this.bus=t,t.ppu=this}},{key:"GetScreen",value:function(){return this.sprScreen}},{key:"GetPatternTable",value:function(t,i){for(var s=0;s<16;s++)for(var h=0;h<16;h++)for(var e=256*s+16*h,r=0;r<8;r++)for(var a=this.ppuRead(4096*t+e+r+0),n=this.ppuRead(4096*t+e+r+8),o=0;o<8;o++){var p=(1&a)<<1|1&n;a>>=1,n>>=1,this.sprPatternTable[t].SetPixel(8*h+(7-o),8*s+r,this.GetColourFromPaletteRam(i,p))}return this.sprPatternTable[t]}},{key:"GetColourFromPaletteRam",value:function(t,i){return this.palScreen[63&this.ppuRead(16128+(t<<2)+i)]}},{key:"GetNameTable",value:function(t){return this.sprNameTable[t]}},{key:"cpuRead",value:function(t,i){var s=0;if(i)switch(t){case 0:s=this.control.reg;break;case 1:s=this.mask.reg;break;case 2:s=this.status.reg}else switch(t){case 0:case 1:break;case 2:s=224&this.status.reg|31&this.ppu_data_buffer,this.status.vertical_blank=0,this.address_latch=0;break;case 3:break;case 4:var h=Math.floor(this.oam_addr/4),e=this.oam_addr%4;s=0===e?this.OAM[h].y:1===e?this.OAM[h].id:2===e?this.OAM[h].attribute:this.OAM[h].x;break;case 5:case 6:break;case 7:s=this.ppu_data_buffer,this.ppu_data_buffer=this.ppuRead(this.vram_addr.reg),this.vram_addr.reg>=16128&&(s=this.ppu_data_buffer),this.vram_addr.reg=this.vram_addr.reg+(this.control.increment_mode?32:1)}return s}},{key:"OAMWrite",value:function(t,i){var s=Math.floor(t/4),h=t%4;0===h?this.OAM[s].y=i:1===h?this.OAM[s].id=i:2===h?this.OAM[s].attribute=i:this.OAM[s].x=i}},{key:"cpuWrite",value:function(t,i){switch(t){case 0:this.control.reg=i,this.tram_addr.nametable_x=this.control.nametable_x?1:0,this.tram_addr.nametable_y=this.control.nametable_y?1:0;break;case 1:this.mask.reg=i;break;case 2:break;case 3:this.oam_addr=i;break;case 4:this.OAMWrite(this.oam_addr,i);break;case 5:0===this.address_latch?(this.fine_x=7&i,this.tram_addr.coarse_x=i>>3,this.address_latch=1):(this.tram_addr.fine_y=7&i,this.tram_addr.coarse_y=i>>3,this.address_latch=0);break;case 6:0===this.address_latch?(this.tram_addr.reg=(63&i)<<8|255&this.tram_addr.reg,this.address_latch=1):(this.tram_addr.reg=65280&this.tram_addr.reg|i,this.vram_addr.reg=this.tram_addr.reg,this.address_latch=0);break;case 7:this.ppuWrite(this.vram_addr.reg,i),this.vram_addr.reg=this.vram_addr.reg+(this.control.increment_mode?32:1)}}},{key:"ppuRead",value:function(t,i){var s=0;t&=16383;var h=this.bus.cart.ppuRead(t,s);return!1!==h?s=h:t>=0&&t<=8191?s=this.tblPattern[(4096&t)>>12][4095&t]:t>=8192&&t<=16127?(t&=4095,this.cart.mirror===H.VERTICAL?(t>=0&&t<=1023&&(s=this.tblName[0][1023&t]),t>=1024&&t<=2047&&(s=this.tblName[1][1023&t]),t>=2048&&t<=3071&&(s=this.tblName[0][1023&t]),t>=3072&&t<=4095&&(s=this.tblName[1][1023&t])):(t>=0&&t<=1023&&(s=this.tblName[0][1023&t]),t>=1024&&t<=2047&&(s=this.tblName[0][1023&t]),t>=2048&&t<=3071&&(s=this.tblName[1][1023&t]),t>=3072&&t<=4095&&(s=this.tblName[1][1023&t]))):t>=16128&&t<=16383&&(16==(t&=31)&&(t=0),20===t&&(t=4),24===t&&(t=8),28===t&&(t=12),s=this.tblPalette[t]&(this.mask.grayscale?48:63)),s||0}},{key:"ppuWrite",value:function(t,i){t&=16383,this.cart.ppuWrite(t,i)||(t>=0&&t<=8191?this.tblPattern[(4096&t)>>12][4095&t]=i:t>=8192&&t<=16127?(t&=4095,this.cart.mirror===H.VERTICAL?(t>=0&&t<=1023&&(this.tblName[0][1023&t]=i),t>=1024&&t<=2047&&(this.tblName[1][1023&t]=i),t>=2048&&t<=3071&&(this.tblName[0][1023&t]=i),t>=3072&&t<=4095&&(this.tblName[1][1023&t]=i)):(t>=0&&t<=1023&&(this.tblName[0][1023&t]=i),t>=1024&&t<=2047&&(this.tblName[0][1023&t]=i),t>=2048&&t<=3071&&(this.tblName[1][1023&t]=i),t>=3072&&t<=4095&&(this.tblName[1][1023&t]=i))):t>=16128&&t<=16383&&(16==(t&=31)&&(t=0),20===t&&(t=4),24===t&&(t=8),28===t&&(t=12),this.tblPalette[t]=i))}},{key:"ConnectCartridge",value:function(t){this.cart=t}},{key:"reset",value:function(){this.fine_x=0,this.address_latch=0,this.ppu_data_buffer=0,this.scanline=0,this.cycle=0,this.bg_next_tile_id=0,this.bg_next_tile_attrib=0,this.bg_next_tile_lsb=0,this.bg_next_tile_msb=0,this.bg_shifter_pattern_lo=0,this.bg_shifter_pattern_hi=0,this.bg_shifter_attrib_lo=0,this.bg_shifter_attrib_hi=0,this.status.reg=0,this.mask.reg=0,this.control.reg=0,this.vram_addr.reg=0,this.tram_addr.reg=0}},{key:"clock",value:function(){var t=this,i=function(){t.bg_shifter_pattern_lo=65280&t.bg_shifter_pattern_lo|t.bg_next_tile_lsb,t.bg_shifter_pattern_hi=65280&t.bg_shifter_pattern_hi|t.bg_next_tile_msb,t.bg_shifter_attrib_lo=65280&t.bg_shifter_attrib_lo|(1&t.bg_next_tile_attrib?255:0),t.bg_shifter_attrib_hi=65280&t.bg_shifter_attrib_hi|(2&t.bg_next_tile_attrib?255:0)};if(this.scanline>=-1&&this.scanline<240){if(0===this.scanline&&0===this.cycle&&(this.cycle=1),-1===this.scanline&&1===this.cycle){this.status.vertical_blank=0,this.status.sprite_overflow=0,this.status.sprite_zero_hit=0;for(var s=0;s<8;s++)this.sprite_shifter_pattern_lo[s]=0,this.sprite_shifter_pattern_hi[s]=0}if(this.cycle>=2&&this.cycle<258||this.cycle>=321&&this.cycle<338)switch(function(){if(t.mask.render_background&&(t.bg_shifter_pattern_lo=t.bg_shifter_pattern_lo<<1&65535,t.bg_shifter_pattern_hi=t.bg_shifter_pattern_hi<<1&65535,t.bg_shifter_attrib_lo=t.bg_shifter_attrib_lo<<1&65535,t.bg_shifter_attrib_hi=t.bg_shifter_attrib_hi<<1&65535),t.mask.render_sprites&&t.cycle>=1&&t.cycle<258)for(var i=0;i<t.sprite_count;i++)t.spriteScanline[i].x>0?t.spriteScanline[i].x--:(t.sprite_shifter_pattern_lo[i]=t.sprite_shifter_pattern_lo[i]<<1&255,t.sprite_shifter_pattern_hi[i]=t.sprite_shifter_pattern_hi[i]<<1&255)}(),(this.cycle-1)%8){case 0:i(),this.bg_next_tile_id=this.ppuRead(8192|4095&this.vram_addr.reg);break;case 2:this.bg_next_tile_attrib=this.ppuRead(9152|this.vram_addr.nametable_y<<11|this.vram_addr.nametable_x<<10|this.vram_addr.coarse_y>>2<<3|this.vram_addr.coarse_x>>2),2&this.vram_addr.coarse_y&&(this.bg_next_tile_attrib>>=4),2&this.vram_addr.coarse_x&&(this.bg_next_tile_attrib>>=2),this.bg_next_tile_attrib&=3;break;case 4:this.bg_next_tile_lsb=this.ppuRead((this.control.pattern_background<<12)+(this.bg_next_tile_id<<4)+this.vram_addr.fine_y+0);break;case 6:this.bg_next_tile_msb=this.ppuRead((this.control.pattern_background<<12)+(this.bg_next_tile_id<<4)+this.vram_addr.fine_y+8);break;case 7:(t.mask.render_background||t.mask.render_sprites)&&(31===t.vram_addr.coarse_x?(t.vram_addr.coarse_x=0,t.vram_addr.nametable_x=t.vram_addr.nametable_x?0:1):t.vram_addr.coarse_x++)}if(256===this.cycle&&(t.mask.render_background||t.mask.render_sprites)&&(t.vram_addr.fine_y<7?t.vram_addr.fine_y++:(t.vram_addr.fine_y=0,29===t.vram_addr.coarse_y?(t.vram_addr.coarse_y=0,t.vram_addr.nametable_y=t.vram_addr.nametable_y?0:1):31===t.vram_addr.coarse_y?t.vram_addr.coarse_y=0:t.vram_addr.coarse_y++)),257===this.cycle&&(i(),(t.mask.render_background||t.mask.render_sprites)&&(t.vram_addr.nametable_x=t.tram_addr.nametable_x,t.vram_addr.coarse_x=t.tram_addr.coarse_x)),338!==this.cycle&&340!==this.cycle||(this.bg_next_tile_id=this.ppuRead(8192|4095&this.vram_addr.reg)),-1===this.scanline&&this.cycle>=280&&this.cycle<305&&(t.mask.render_background||t.mask.render_sprites)&&(t.vram_addr.fine_y=t.tram_addr.fine_y,t.vram_addr.nametable_y=t.tram_addr.nametable_y,t.vram_addr.coarse_y=t.tram_addr.coarse_y),257===this.cycle&&this.scanline>=0){for(var h=0;h<8;h++)this.spriteScanline[h]={};this.sprite_count=0;for(var e=0;e<8;e++)this.sprite_shifter_pattern_lo[e]=0,this.sprite_shifter_pattern_hi[e]=0;var r=0;for(this.bSpriteZeroHitPossible=!1;r<64&&this.sprite_count<9;){var a=this.scanline-this.OAM[r].y;a>=0&&a<(this.control.sprite_size?16:8)&&this.sprite_count<8&&(0===r&&(this.bSpriteZeroHitPossible=!0),this.spriteScanline[this.sprite_count]=q({},this.OAM[r]),this.sprite_count++),r++}this.status.sprite_overflow=this.sprite_count>8?1:0}if(340===this.cycle)for(var n=0;n<this.sprite_count;n++){var o,p=void 0,l=void 0,c=void 0;if(o=8+(c=this.control.sprite_size?128&this.spriteScanline[n].attribute?this.scanline-this.spriteScanline[n].y<8?(1&this.spriteScanline[n].id)<<12|1+(254&this.spriteScanline[n].id)<<4|7-(this.scanline-this.spriteScanline[n].y)&7:(1&this.spriteScanline[n].id)<<12|(254&this.spriteScanline[n].id)<<4|7-(this.scanline-this.spriteScanline[n].y)&7:this.scanline-this.spriteScanline[n].y<8?(1&this.spriteScanline[n].id)<<12|(254&this.spriteScanline[n].id)<<4|this.scanline-this.spriteScanline[n].y&7:(1&this.spriteScanline[n].id)<<12|1+(254&this.spriteScanline[n].id)<<4|this.scanline-this.spriteScanline[n].y&7:128&this.spriteScanline[n].attribute?this.control.pattern_sprite<<12|this.spriteScanline[n].id<<4|7-(this.scanline-this.spriteScanline[n].y):this.control.pattern_sprite<<12|this.spriteScanline[n].id<<4|this.scanline-this.spriteScanline[n].y),p=this.ppuRead(c),l=this.ppuRead(o),64&this.spriteScanline[n].attribute){var u=function(t){return t=(170&(t=(204&(t=(240&t)>>4|(15&t)<<4))>>2|(51&t)<<2))>>1|(85&t)<<1};p=u(p),l=u(l)}this.sprite_shifter_pattern_lo[n]=p,this.sprite_shifter_pattern_hi[n]=l}}this.scanline,this.scanline>=241&&this.scanline<261&&241===this.scanline&&1===this.cycle&&(this.status.vertical_blank=1,this.control.enable_nmi&&(this.nmi=!0));var d=0,m=0;if(this.mask.render_background){var f=32768>>this.fine_x,b=(this.bg_shifter_pattern_lo&f)>0?1:0;d=((this.bg_shifter_pattern_hi&f)>0?1:0)<<1|b;var y=(this.bg_shifter_attrib_lo&f)>0?1:0;m=((this.bg_shifter_attrib_hi&f)>0?1:0)<<1|y}var k=0,_=0,x=0;if(this.mask.render_sprites){this.bSpriteZeroBeingRendered=!1;for(var v=0;v<this.sprite_count;v++)if(0===this.spriteScanline[v].x){var w=(128&this.sprite_shifter_pattern_lo[v])>0;if(k=((128&this.sprite_shifter_pattern_hi[v])>0)<<1|w,_=4+(3&this.spriteScanline[v].attribute),x=0==(32&this.spriteScanline[v].attribute),0!==k){0===v&&(this.bSpriteZeroBeingRendered=!0);break}}}var g=0,S=0;0===d&&0===k?(g=0,S=0):0===d&&k>0?(g=k,S=_):d>0&&0===k?(g=d,S=m):d>0&&k>0&&(x?(g=k,S=_):(g=d,S=m),this.bSpriteZeroHitPossible&&this.bSpriteZeroBeingRendered&&this.mask.render_background&this.mask.render_sprites&&(~(this.mask.render_background_left|this.mask.render_sprites_left)?this.cycle>=9&&this.cycle<258&&(this.status.sprite_zero_hit=1):this.cycle>=1&&this.cycle<258&&(this.status.sprite_zero_hit=1)));var z=this.GetColourFromPaletteRam(S,g);this.sprScreen.SetPixel(this.cycle-1,this.scanline,z),this.cycle++,this.cycle>=341&&(this.cycle=0,this.scanline++,this.scanline>=261&&(this.scanline=-1,this.frame_complete=!0))}}])&&K(i.prototype,s),h&&K(i,h),t}();function tt(t,i){for(var s=0;s<i.length;s++){var h=i[s];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(t,h.key,h)}}var it=function(){function t(i,s){var h=this;!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,t),this.displayCanvas=i,this.debugCanvas=s,this.nes=new e,this.ppu=new Q(i),this.cpu=new T,this.cpu.ConnectBus(this.nes),this.ppu.ConnectBus(this.nes),this.cartridge=new H,this.bEmulationRun=!1,this.mapAsm=[],this.keys={a:!1,b:!1,select:!1,start:!1,up:!1,down:!1,left:!1,right:!1},this.keyMapping={x:"a",z:"b",s:"start",a:"select",ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right"},window.addEventListener("keydown",(function(t){h.keyMapping[t.key]&&(h.keys[h.keyMapping[t.key]]=!0,t.preventDefault())}),!0),window.addEventListener("keyup",(function(t){h.keyMapping[t.key]&&(h.keys[h.keyMapping[t.key]]=!1,t.preventDefault())}),!0),this.step=this.step.bind(this)}var i,s,h;return i=t,(s=[{key:"hex",value:function(t,i){for(var s=[],h=i-1;h>=0;h--,t>>=4)s[h]="0123456789ABCDEF"[15&t];return s.join("")}},{key:"DrawString",value:function(t,i,s,h){this.debugCanvas.fillStyle=h||"#FFFFFF",this.debugCanvas.fillText(s,t,i)}},{key:"DrawRect",value:function(t,i,s,h,e){this.debugCanvas.fillStyle=e instanceof U?e.getCode():e||"#FFFFFF",this.debugCanvas.fillRect(t,i,s,h)}},{key:"DrawCpu",value:function(t,i){this.DrawString(t+64,i,"N",this.nes.cpu.GetFlag(T.FLAGS6502.N)?"#00FF00":"#FF0000"),this.DrawString(t+80,i,"V",this.nes.cpu.GetFlag(T.FLAGS6502.V)?"#00FF00":"#FF0000"),this.DrawString(t+96,i,"-",this.nes.cpu.GetFlag(T.FLAGS6502.U)?"#00FF00":"#FF0000"),this.DrawString(t+112,i,"B",this.nes.cpu.GetFlag(T.FLAGS6502.B)?"#00FF00":"#FF0000"),this.DrawString(t+128,i,"D",this.nes.cpu.GetFlag(T.FLAGS6502.D)?"#00FF00":"#FF0000"),this.DrawString(t+144,i,"I",this.nes.cpu.GetFlag(T.FLAGS6502.I)?"#00FF00":"#FF0000"),this.DrawString(t+160,i,"Z",this.nes.cpu.GetFlag(T.FLAGS6502.Z)?"#00FF00":"#FF0000"),this.DrawString(t+178,i,"C",this.nes.cpu.GetFlag(T.FLAGS6502.C)?"#00FF00":"#FF0000"),this.DrawString(t,i+10,"PC: $"+this.hex(this.nes.cpu.pc,4)),this.DrawString(t,i+20,"A: $"+this.hex(this.nes.cpu.a||this.nes.cpu.A,2)+"  ["+this.nes.cpu.a+"]"),this.DrawString(t,i+30,"X: $"+this.hex(this.nes.cpu.x||this.nes.cpu.X,2)+"  ["+this.nes.cpu.x+"]"),this.DrawString(t,i+40,"Y: $"+this.hex(this.nes.cpu.y||this.nes.cpu.Y,2)+"  ["+this.nes.cpu.y+"]"),this.DrawString(t,i+50,"Stack P: $"+this.hex(this.nes.cpu.stkp,4))}},{key:"DrawCode",value:function(t,i,s){var h=this.nes.cpu.pc,e=10*(s>>1)+i;if(h!==this.mapAsm.length)for(this.DrawString(t,e,this.mapAsm[h],"#FF0000");e<10*s+i&&h<mapAsm.length;)++h!==this.mapAsm.length&&this.mapAsm[h]&&(e+=10,this.DrawString(t,e,this.mapAsm[h]));if(e=10*(s>>1)+i,(h=this.nes.cpu.pc)!==this.mapAsm.length)for(;e>i&&h>0;)--h!==this.mapAsm.length&&this.mapAsm[h]&&(e-=10,this.DrawString(t,e,this.mapAsm[h]))}},{key:"handleFile",value:function(t){var i=this;this.cartridge.loadFile(t,(function(){i.nes.insertCartridge(i.cartridge),i.nes.reset(),i.mapAsm=i.nes.cpu.disassemble(0,65535)}))}},{key:"start",value:function(){this.bEmulationRun=!this.bEmulationRun,this.step()}},{key:"reset",value:function(){this.nes.reset()}},{key:"stepLine",value:function(){do{this.nes.clock()}while(!this.nes.cpu.complete())}},{key:"debug",value:function(){this.debugCanvas.fillStyle="#000099",this.debugCanvas.fillRect(0,0,500,500),this.DrawCpu(0,50),this.DrawCode(200,72,26);for(var t=0;t<26;t++){var i=this.hex(t,2)+": ("+this.nes.ppu.OAM[t].x+", "+this.nes.ppu.OAM[t].y+") ID: "+hex(this.nes.ppu.OAM[t].id,2)+" AT: "+hex(this.nes.ppu.OAM[t].attribute,2);this.DrawString(0,172+10*t,i)}for(var s=0;s<8;s++)for(var h=0;h<4;h++)this.DrawRect(20+40*s+8*h,20,8,8,this.ppu.GetColourFromPaletteRam(s,h));this.debugCanvas.putImageData(this.ppu.GetPatternTable(0,0).ctx,150,360),this.debugCanvas.putImageData(this.ppu.GetPatternTable(1,0).ctx,300,360)}},{key:"step",value:function(){if(this.nes.controller[0]=0,this.nes.controller[0]|=this.keys.a?128:0,this.nes.controller[0]|=this.keys.b?64:0,this.nes.controller[0]|=this.keys.select?32:0,this.nes.controller[0]|=this.keys.start?16:0,this.nes.controller[0]|=this.keys.up?8:0,this.nes.controller[0]|=this.keys.down?4:0,this.nes.controller[0]|=this.keys.left?2:0,this.nes.controller[0]|=this.keys.right?1:0,this.bEmulationRun){do{this.nes.clock()}while(!this.nes.ppu.frame_complete);this.nes.ppu.frame_complete=!1}return this.displayCanvas.putImageData(this.nes.ppu.GetScreen().ctx,0,0),!0}}])&&tt(i.prototype,s),h&&tt(i,h),t}();window.App=it}]);